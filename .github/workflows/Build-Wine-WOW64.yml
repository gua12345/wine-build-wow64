name: 编译 Wine WOW64

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码库
      uses: actions/checkout@v2

    - name: 安装依赖项
      run: |
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt install -y build-essential gcc-multilib g++-multilib libglib2.0-dev libc6-dev libc6-dev-i386 libfreetype6-dev libx11-dev libxext-dev libxrender-dev libxi-dev libxt-dev lib32z1-dev lib32ncurses5-dev libxcomposite-dev libxinerama-dev libxxf86vm-dev libxrandr-dev libxfixes-dev libxml2-dev libasound2-dev libgsm1-dev libjpeg-dev libpng-dev libtiff-dev libxinerama-dev libxrandr-dev liblcms2-dev libgnutls28-dev libavcodec-dev libxcomposite-dev libxcursor-dev libxkbfile-dev libxmu-dev libxpm-dev libxslt1-dev libosmesa6-dev gettext bison flex wget

    - name: 下载 Wine 9.13 源代码
      run: |
        wget https://dl.winehq.org/wine/source/9.x/wine-9.13.tar.xz
        tar -xvf wine-9.13.tar.xz

    - name: 编译 64 位 Wine
      run: |
        cd wine-9.13
        mkdir wine64
        cd wine64
        ../configure --prefix=/opt/wine64 --enable-win64
        make -j$(nproc)

    - name: 编译 32 位 Wine
      run: |
        cd wine-9.13
        mkdir wine32
        cd wine32
        ../configure --prefix=/opt/wine32 --with-wine64=../wine64
        make -j$(nproc)

    - name: 合并 32 位和 64 位 Wine
      run: |
        cd wine-9.13/wine32
        ../configure --prefix=/opt/wine --with-wine64=../wine64
        make -j$(nproc)

    - name: 打包 Wine 二进制文件
      run: |
        tar -czvf wine-wow64-9.13.tar.gz -C /opt wine

    - name: 上传构建工件
      uses: actions/upload-artifact@v2
      with:
        name: wine-wow64-9.13
        path: wine-wow64-9.13.tar.gz
